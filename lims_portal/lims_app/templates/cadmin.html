{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Library Admin Dashboard - eTala</title>
    <link rel="stylesheet" href="https://public.codepenassets.com/css/normalize-5.0.0.min.css">
    <link rel="stylesheet" href="{% static 'Scripts/css/cadmin.css' %}">
    <link rel="icon" href="{% static 'img/etalalogo.svg' %}">
    <style>
      /* Grade section styling */
      .grade-section summary {
        background: #4a5568;
      }
      
      .grade-section summary:hover {
        background: #2d3748 !important;
        transform: translateX(2px);
        box-shadow: 0 2px 8px rgba(74, 85, 104, 0.3);
      }
      
      .grade-section summary:active {
        transform: scale(0.98);
      }
      
      /* Dark mode styles for grade sections */
      html.dark .grade-section summary {
        background: #374151;
      }
      
      html.dark .grade-section summary:hover {
        background: #4b5563 !important;
        box-shadow: 0 2px 8px rgba(107, 114, 128, 0.4);
      }
      
      html.dark .grade-section .user-item {
        border-left-color: #6b7280 !important;
      }
      
      html.dark .grade-section .user-item button {
        background: #4b5563 !important;
      }
      
      html.dark .grade-section .user-item button:hover {
        background: #6b7280 !important;
      }
    </style>

  </head>
    
  <body>
  <div class="app-container">
  <div class="app-header">
    <div class="app-header-left">
      <span class="app-icon"></span>
      <p class="app-name">Library Admin</p>
      <div class="search-wrapper">
        <input class="search-input" type="text" placeholder="Search">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-search" viewBox="0 0 24 24">
          <defs></defs>
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
      </div>
    </div>
    <div class="app-header-right">
      <button class="mode-switch" title="Switch Theme">
        <svg class="moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="24" height="24" viewBox="0 0 24 24">
          <defs></defs>
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
        </svg>
      </button>
    </div>
  </div>
  <div class="app-content">
    <div class="app-sidebar">
      <a href="{% url 'admin_dashboard' %}" class="app-sidebar-link active" data-view="borrowed">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <polyline points="9 22 9 12 15 12 15 22" /></svg>
      </a>
      <a href="#" class="app-sidebar-link" data-view="checkout" onclick="showView('checkout'); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-plus-circle" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 8v8M8 12h8" />
        </svg>
      </a>
      <a href="#" class="app-sidebar-link" data-view="return" onclick="showView('return'); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left-circle">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 8l-4 4 4 4M16 12H8" /></svg>
      </a>
      <a href="#" class="app-sidebar-link" onclick="toggleSidebarSection('books'); return false;" title="Books">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
      </a>
      <a href="#" class="app-sidebar-link" onclick="toggleSidebarSection('users'); return false;" title="Users">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      </a>
      <a href="{% url 'admin_logout' %}" class="app-sidebar-link" title="Logout">
        <svg class="link-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-log-out" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" y1="12" x2="9" y2="12" />
        </svg>
      </a>
    </div>
    
    <!-- Books Sidebar Section -->
    <div id="sidebar-books" class="sidebar-section" style="display: none;">
      <div style="padding: 12px; border-bottom: 1px solid var(--message-box-border); flex: 0 0 auto;">
        <!-- Header with title and close button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="margin: 0; font-size: 0.95rem; color: var(--main-color); font-weight: 600;">Books</h3>
          <button onclick="toggleSidebarSection('books'); return false;" style="background: none; border: none; cursor: pointer; color: var(--main-color); font-size: 1.3rem; padding: 0; width: 24px; height: 24px; line-height: 1;">&times;</button>
        </div>
        
        <!-- Action button -->
        <div style="margin-bottom: 10px;">
          <button type="button" onclick="openBookAddModal(); return false;" style="width: 100%; background: #3368a4; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 0.8rem; cursor: pointer; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#255783'" onmouseout="this.style.background='#3368a4'">+ Add Book</button>
        </div>
        
        <!-- Stats badges -->
        <div style="display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;">
          <span style="background: #3368a4; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">{{ total_books_count }} Total</span>
          <span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">{{ available_books_count }} Available</span>
          <span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">{{ borrowed_books|length }} Borrowed</span>
        </div>
        
        <!-- Search box -->
        <div>
          <input type="text" id="bookSearch" placeholder="Search books..." onkeyup="searchBooks()" style="width: 100%; padding: 10px 12px; border: 2px solid var(--message-box-border); border-radius: 8px; background: var(--search-area-bg); color: var(--main-color); font-size: 0.85rem; box-sizing: border-box;">
        </div>
      </div>
      <div id="booksList" style="flex: 1; overflow-y: auto; padding: 12px; min-height: 0;">
        {% for book in all_books %}
        <div class="book-item" data-title="{{ book.Title|lower }}" data-author="{{ book.mainAuthor|lower }}" data-callnumber="{{ book.callNumber|lower }}" style="padding: 12px; margin-bottom: 10px; background: var(--message-box-hover); border-radius: 8px; border-left: 4px solid {% if book.available_copies > 0 %}#28a745{% else %}#dc3545{% endif %}; position: relative;">
          <button onclick="openBookEditModal('{{ book.id }}', '{{ book.Title|escapejs }}', '{{ book.mainAuthor|escapejs }}', '{{ book.coAuthor|escapejs }}', '{{ book.Publisher|escapejs }}', '{{ book.Edition|escapejs }}', '{{ book.callNumber|escapejs }}', '{{ book.Language }}', '{{ book.Type }}', '{{ book.copies_json|escapejs }}')" style="position: absolute; top: 10px; right: 10px; background: #3368a4; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.7rem; cursor: pointer;">Edit</button>
          
          <div style="font-weight: 600; font-size: 0.9rem; color: var(--main-color); margin-bottom: 6px; padding-right: 50px;">{{ book.Title }}</div>
          <div style="font-size: 0.75rem; color: var(--secondary-color); margin-bottom: 6px;">{{ book.mainAuthor }}</div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px; background: var(--app-container); border-radius: 6px;">
            <span style="font-size: 0.75rem; color: var(--main-color); font-weight: 500;">{{ book.available_copies }} available / {{ book.total_copies }} copies</span>
            <span style="font-size: 0.7rem; color: var(--secondary-color);">{{ book.callNumber }}</span>
          </div>
          
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer; font-size: 0.75rem; font-weight: 500; color: var(--main-color); padding: 4px; border-radius: 4px; background: var(--app-container);">View All Copies ({{ book.total_copies }})</summary>
            <div style="margin-top: 8px; padding-left: 8px;">
              {% for copy in book.copies %}
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; margin-bottom: 4px; background: var(--app-container); border-radius: 4px; border-left: 2px solid {% if copy.status == 'Available' %}#28a745{% else %}#dc3545{% endif %};">
                <div style="flex: 1;">
                  <div style="font-size: 0.7rem; font-weight: 500; color: var(--main-color);">{{ copy.accessionNumber }}</div>
                  <div style="font-size: 0.65rem; color: var(--secondary-color);">{{ copy.Location }}</div>
                </div>
                <span style="padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; {% if copy.status == 'Available' %}background: #d4edda; color: #155724;{% else %}background: #f8d7da; color: #721c24;{% endif %}">{{ copy.status }}</span>
              </div>
              {% empty %}
              <p style="font-size: 0.7rem; color: var(--secondary-color); padding: 8px;">No copies available</p>
              {% endfor %}
            </div>
          </details>
        </div>
        {% empty %}
        <p style="text-align: center; color: var(--secondary-color); padding: 20px; font-size: 0.8rem;">No books</p>
        {% endfor %}
      </div>
    </div>
    
    <!-- Users Sidebar Section -->
    <div id="sidebar-users" class="sidebar-section" style="display: none;">
      <div style="padding: 12px; border-bottom: 1px solid var(--message-box-border); flex: 0 0 auto;">
        <!-- Header with title and close button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="margin: 0; font-size: 0.95rem; color: var(--main-color); font-weight: 600;">Students</h3>
          <button onclick="toggleSidebarSection('users'); return false;" style="background: none; border: none; cursor: pointer; color: var(--main-color); font-size: 1.3rem; padding: 0; width: 24px; height: 24px; line-height: 1;">&times;</button>
        </div>
        
        <!-- Action button -->
        <div style="margin-bottom: 10px;">
          <button type="button" onclick="openUserAddModal(); return false;" style="width: 100%; background: #28a745; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 0.8rem; cursor: pointer; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">+ Add Student</button>
        </div>
        
        <!-- Stats badge -->
        <div style="margin-bottom: 10px;">
          <span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">{{ total_users_count }} Students</span>
        </div>
        
        <!-- Search box -->
        <div>
          <input type="text" id="userSearch" placeholder="Search students..." onkeyup="searchUsers()" style="width: 100%; padding: 10px 12px; border: 2px solid var(--message-box-border); border-radius: 8px; background: var(--search-area-bg); color: var(--main-color); font-size: 0.85rem; box-sizing: border-box;">
        </div>
      </div>
      <div id="usersList" style="flex: 1; overflow-y: auto; padding: 12px; min-height: 0;">
        {% for grade_num in "7,8,9,10,11,12"|split:"," %}
        <details class="grade-section" {% if grade_num == "7" %}open{% endif %} style="margin-bottom: 8px; border-radius: 8px; overflow: hidden; background: var(--message-box-hover);">
          <summary style="cursor: pointer; padding: 10px 12px; color: white; font-weight: 600; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: all 0.3s ease;">
            <span>Grade {{ grade_num }}</span>
            <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">{{ students_by_grade|get_item:grade_num|length }}</span>
          </summary>
          <div style="padding: 8px;">
            {% for user in students_by_grade|get_item:grade_num %}
            <div class="user-item" data-name="{{ user.name|lower }}" data-schoolid="{{ user.school_id|lower }}" data-grade="grade {{ grade_num }}" data-batch="{{ user.batch|lower }}" style="padding: 10px; margin-bottom: 6px; background: var(--app-container); border-radius: 6px; border-left: 3px solid #4a5568; position: relative;">
              <button onclick="openUserEditModal('{{ user.school_id|escapejs }}', '{{ user.name|escapejs }}', '{{ user.email|escapejs }}', '{{ grade_num }}', '{{ user.batch|escapejs }}')" style="position: absolute; top: 6px; right: 6px; background: #4a5568; color: white; border: none; border-radius: 4px; padding: 3px 6px; font-size: 0.65rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2d3748'" onmouseout="this.style.background='#4a5568'">Edit</button>
              <div style="font-weight: 600; font-size: 0.8rem; color: var(--main-color); margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 45px;">{{ user.name }}</div>
              <div style="font-size: 0.7rem; color: var(--secondary-color); margin-bottom: 2px;">{{ user.school_id }}</div>
              <div style="font-size: 0.65rem; color: var(--secondary-color);">{{ user.batch }}</div>
            </div>
            {% empty %}
            <p style="text-align: center; color: var(--secondary-color); padding: 12px; font-size: 0.75rem;">No students in this grade</p>
            {% endfor %}
          </div>
        </details>
        {% endfor %}
      </div>
    </div>
    
    <div class="projects-section">
      <!-- Borrowed Books View -->
      <div id="borrowed-view" class="view-section">
        <div class="projects-section-header">
          <p>Borrowed Books</p>
          <div style="display:flex; align-items:center; gap:10px;">
            <form method="post" action="{% url 'admin_dashboard' %}" style="margin:0;">
              {% csrf_token %}
              <input type="hidden" name="action" value="create_backup">
              <button type="submit" class="btn-secondary" style="height: 34px; padding: 0 12px;">Backup</button>
            </form>
            <button type="button" class="btn-secondary" style="height: 34px; padding: 0 12px;" onclick="openMoveUpModal();">Move-Up</button>
            <p class="time" style="margin:0;">{{ borrowed_books|length }} Total</p>
          </div>
        </div>
        
        <!-- Messages for borrowed view -->
        {% if messages %}
          <div class="messages" style="margin: 1rem 0;">
            {% for message in messages %}
              {% if message.tags == 'success' %}
                <div style="color: #155724; background: #d4edda; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #28a745; margin-bottom: 0.5rem;">
                  <strong>✓ Success:</strong> {{ message }}
                </div>
              {% else %}
                <div style="color: #721c24; background: #f8d7da; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #dc3545; margin-bottom: 0.5rem;">
                  <strong>✗ Error:</strong> {{ message }}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        
        <div class="projects-section-line">
          <div class="projects-status">
            <div class="item-status">
              <span class="status-number">{{ borrowed_books|length }}</span>
              <span class="status-type">Borrowed</span>
            </div>
            <div class="item-status">
              <span class="status-number">{{ overdue_books|length }}</span>
              <span class="status-type">Overdue</span>
            </div>
            <div class="item-status">
              <span class="status-number">{{ available_books_count }}</span>
              <span class="status-type">Available</span>
            </div>
            <div class="item-status">
              <span class="status-number">{{ total_books_count }}</span>
              <span class="status-type">Total Books</span>
            </div>
            <div class="item-status">
              <span class="status-number">{{ total_users_count }}</span>
              <span class="status-type">Registered Users</span>
            </div>
          </div>
          <div class="view-actions">
            <button class="view-btn list-view" title="List View">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list">
                <line x1="8" y1="6" x2="21" y2="6" />
                <line x1="8" y1="12" x2="21" y2="12" />
                <line x1="8" y1="18" x2="21" y2="18" />
                <line x1="3" y1="6" x2="3.01" y2="6" />
                <line x1="3" y1="12" x2="3.01" y2="12" />
                <line x1="3" y1="18" x2="3.01" y2="18" /></svg>
            </button>
            <button class="view-btn grid-view active" title="Grid View">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-grid">
                <rect x="3" y="3" width="7" height="7" />
                <rect x="14" y="3" width="7" height="7" />
                <rect x="14" y="14" width="7" height="7" />
                <rect x="3" y="14" width="7" height="7" /></svg>
            </button>
          </div>
        </div>
        <div class="project-boxes jsGridView">
          {% for borrow in borrowed_books %}
          <div class="project-box-wrapper">
            <div class="project-box" style="background-color: {% if borrow.is_overdue %}#f8d7da{% else %}#d4edda{% endif %}">
              <div class="project-box-header">
                <span>{{ borrow.borrow_date|date:"M d, Y" }}</span>
                <div class="more-wrapper">
                  <button class="project-btn-more">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-vertical">
                      <circle cx="12" cy="12" r="1" />
                      <circle cx="12" cy="5" r="1" />
                      <circle cx="12" cy="19" r="1" /></svg>
                  </button>
                </div>
              </div>
              <div class="project-box-content-header">
                <p class="box-content-header">{{ borrow.bookTitle }}</p>
                <p class="box-content-subheader">{{ borrow.accountName }} ({{ borrow.accountID }})</p>
              </div>
              <div class="box-progress-wrapper">
                <p class="box-progress-header">Due Date</p>
                <div class="box-progress-bar">
                  <span class="box-progress" style="width: {% if borrow.is_overdue %}100{% else %}50{% endif %}%; background-color: {% if borrow.is_overdue %}#dc3545{% else %}#28a745{% endif %}"></span>
                </div>
                <p class="box-progress-percentage">{{ borrow.return_date|date:"M d" }}</p>
              </div>
              <div class="project-box-footer">
                <div class="participants">
                  <span style="font-size: 12px;">Accession: {{ borrow.bookID }}</span>
                </div>
                <div class="days-left" style="color: {% if borrow.is_overdue %}#dc3545{% else %}#28a745{% endif %}">
                  {% if borrow.is_overdue %}Overdue{% else %}On Time{% endif %}
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <p>No books are currently borrowed.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Checkout View -->
      <div id="checkout-view" class="view-section" style="display: none;">
        <div class="projects-section-header">
          <p>Checkout Book</p>
        </div>
        
        <!-- Dynamic Status Message -->
        <div id="checkout-status" style="margin: 1rem 0; display: none;"></div>
        
        {% if messages %}
          <div class="messages" style="margin: 1rem 0;">
            {% for message in messages %}
              {% if message.tags == 'success' %}
                <div style="color: #155724; background: #d4edda; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #28a745; margin-bottom: 0.5rem;">
                  <strong>✓ Success:</strong> {{ message }}
                </div>
              {% else %}
                <div style="color: #721c24; background: #f8d7da; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #dc3545; margin-bottom: 0.5rem;">
                  <strong>✗ Error:</strong> {{ message }}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        <form method="post" action="{% url 'admin_dashboard' %}" id="checkout-form" style="background: white; padding: 2rem; border-radius: 8px; border: 2px solid #3368a4;">
          {% csrf_token %}
          <input type="hidden" name="action" value="checkout">
          <input type="hidden" name="active_view" value="checkout">
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Scan Barcode</label>
            <input 
              type="text" 
              name="book_id" 
              id="checkout-barcode-input"
              placeholder="Scan book barcode (accession number)..." 
              required 
              style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: monospace;">
          </div>
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Student School ID</label>
            <input type="text" name="student_id" id="checkout-student-input" placeholder="Enter student ID" required style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; box-sizing: border-box;">
          </div>
          <button type="submit" id="checkout-submit-btn" style="padding: 0.75rem 1.5rem; background: #3368a4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600;">Checkout Book</button>
        </form>
      </div>

      <!-- Return View -->
      <div id="return-view" class="view-section" style="display: none;">
        <div class="projects-section-header">
          <p>Return Book</p>
        </div>
        
        <!-- Dynamic Status Message -->
        <div id="return-status" style="margin: 1rem 0; display: none;"></div>
        
        <!-- Barcode Scanner Section -->
        <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #3368a4;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3368a4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="9" y1="3" x2="9" y2="21"/>
              <line x1="15" y1="3" x2="15" y2="21"/>
            </svg>
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.25rem 0; color: #3368a4;">Quick Return via Barcode</h4>
              <p style="margin: 0; font-size: 0.85rem; color: #666;">Scan the book's accession number to return</p>
            </div>
          </div>
          <form method="post" action="{% url 'admin_dashboard' %}" id="barcode-return-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="return_barcode">
            <input type="hidden" name="active_view" value="return">
            <div style="display: flex; gap: 1rem;">
              <input 
                type="text" 
                name="accession_number" 
                id="barcode-input"
                placeholder="Scan or type accession number..." 
                autofocus
                style="flex: 1; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: monospace;">
              <button type="submit" id="return-submit-btn" style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; white-space: nowrap;">Return Book</button>
            </div>
          </form>
          <div id="barcode-status" style="margin-top: 0.75rem; padding: 0.75rem; border-radius: 4px; display: none;"></div>
        </div>

        {% if messages %}
          <div class="messages" style="margin: 1rem 0;">
            {% for message in messages %}
              {% if message.tags == 'success' %}
                <div style="color: #155724; background: #d4edda; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #28a745; margin-bottom: 0.5rem;">
                  <strong>✓ Success:</strong> {{ message }}
                </div>
              {% else %}
                <div style="color: #721c24; background: #f8d7da; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #dc3545; margin-bottom: 0.5rem;">
                  <strong>✗ Error:</strong> {{ message }}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        <div class="projects-section-header" style="margin-top: 2rem;">
          <p>Currently Borrowed Books</p>
          <p class="time">{{ borrowed_books|length }} Total</p>
        </div>
        <div class="project-boxes jsGridView">
          {% for borrow in borrowed_books %}
          <div class="project-box-wrapper">
            <div class="project-box" style="background-color: {% if borrow.is_overdue %}#fff3cd{% else %}#e7f1ff{% endif %}">
              <div class="project-box-header">
                <span>{{ borrow.borrow_date|date:"M d, Y" }}</span>
              </div>
              <div class="project-box-content-header">
                <p class="box-content-header">{{ borrow.bookTitle }}</p>
                <p class="box-content-subheader">{{ borrow.accountName }} ({{ borrow.accountID }})</p>
              </div>
              <div class="box-progress-wrapper">
                <p class="box-progress-header">Status</p>
                <p class="box-progress-percentage" style="color: {% if borrow.is_overdue %}#dc3545{% else %}#28a745{% endif %}">
                  {% if borrow.is_overdue %}Overdue{% else %}On Time{% endif %}
                </p>
              </div>
              <div class="project-box-footer">
                <div class="participants">
                  <span style="font-size: 12px;">Due: {{ borrow.return_date|date:"M d" }}</span>
                </div>
                <form method="post" action="{% url 'admin_dashboard' %}" style="display: inline;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="return">
                  <input type="hidden" name="active_view" value="borrowed">
                  <input type="hidden" name="borrow_id" value="{{ borrow.id }}">
                  <button type="submit" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Return</button>
                </form>
              </div>
            </div>
          </div>
          {% empty %}
          <p>No books are currently borrowed.</p>
          {% endfor %}
        </div>
      </div>
</div>
<div class="messages-section">
  <button class="messages-close">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle">
      <circle cx="12" cy="12" r="10" />
      <line x1="15" y1="9" x2="9" y2="15" />
      <line x1="9" y1="9" x2="15" y2="15" /></svg>
  </button>
  <div class="projects-section-header">
    <p>Recent Activity</p>
  </div>
  <div class="messages">
    {% for activity in recent_activity %}
    <div class="message-box">
      <div class="message-content">
        <div class="message-header">
          <div class="name">{{ activity.accountName }}</div>
        </div>
        <p class="message-line">
          {% if activity.returned %}
            Returned "{{ activity.bookTitle }}"
          {% else %}
            Borrowed "{{ activity.bookTitle }}"
          {% endif %}
        </p>
        <p class="message-line time">
          {{ activity.borrow_date|date:"M d, Y" }}
        </p>
      </div>
    </div>
    {% empty %}
    <p style="padding: 1rem;">No recent activity.</p>
    {% endfor %}
  </div>
</div>
</div>
</div>

    <!-- Add Book Modal -->
    <div id="addBookModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 style="margin: 0; color: #333;">Add Book</h2>
          <button onclick="closeBookAddModal()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'admin_dashboard' %}" id="addBookForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_book">

          <div class="form-row">
            <div class="form-group">
              <label>Title *</label>
              <input type="text" name="title" id="addBookTitle" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Main Author *</label>
              <input type="text" name="main_author" id="addBookMainAuthor" required>
            </div>
            <div class="form-group">
              <label>Co-Author</label>
              <input type="text" name="co_author" id="addBookCoAuthor">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Publisher</label>
              <input type="text" name="publisher" id="addBookPublisher">
            </div>
            <div class="form-group">
              <label>Edition</label>
              <input type="text" name="edition" id="addBookEdition">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Call Number *</label>
              <input type="text" name="call_number" id="addBookCallNumber" required>
              <small style="display:block; color: var(--secondary-color); margin-top: 4px;">One Book per Call Number; add multiple copies below (unique Accession Numbers).</small>
            </div>
            <div class="form-group">
              <label>Language</label>
              <select name="language" id="addBookLanguage">
                <option value="English">English</option>
                <option value="Filipino">Filipino</option>
                <option value="Spanish">Spanish</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Type</label>
              <select name="type" id="addBookType">
                <option value="Analytics">Analytics</option>
                <option value="Article">Article</option>
                <option value="Books">Books</option>
                <option value="Thesis">Thesis</option>
                <option value="DOST Resources">DOST Resources</option>
                <option value="Journal">Journal</option>
                <option value="US Reference Materials">US Reference Materials</option>
                <option value="Other" selected>Other</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group" style="width: 100%;">
              <label>Copies (one per line) *</label>
              <textarea name="copies_list" id="addBookCopies" required rows="6" style="width: 100%; padding: 10px; border: 2px solid var(--message-box-border); border-radius: 8px; background: var(--search-area-bg); color: var(--main-color); box-sizing: border-box; resize: vertical;" placeholder="ACC001, Main Library, Available
ACC002, Main Library, Borrowed
ACC003, Annex, Unavailable"></textarea>
              <small style="display:block; color: var(--secondary-color); margin-top: 6px;">Format: AccessionNumber, Location, Status (Available/Unavailable/Borrowed/Lost). Status defaults to Available if omitted.</small>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" onclick="closeBookAddModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Add Book</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 style="margin: 0; color: #333;">Add User</h2>
          <button onclick="closeUserAddModal()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'admin_dashboard' %}" id="addUserForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_user">

          <div class="form-row">
            <div class="form-group">
              <label>Grade *</label>
              <select name="grade_num" id="addUserGrade" required>
                <option value="7">Grade 7</option>
                <option value="8">Grade 8</option>
                <option value="9">Grade 9</option>
                <option value="10">Grade 10</option>
                <option value="11">Grade 11</option>
                <option value="12">Grade 12</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" name="name" id="addUserName" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>School ID *</label>
              <input type="text" name="school_id" id="addUserSchoolId" required>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select name="gender" id="addUserGender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other" selected>Other</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" name="email" id="addUserEmail" required>
            </div>
            <div class="form-group">
              <label>Batch</label>
              <input type="text" name="batch" id="addUserBatch">
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" onclick="closeUserAddModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Add User</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Book Modal -->
    <div id="editBookModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 style="margin: 0; color: #333;">Edit Book</h2>
          <button onclick="closeBookEditModal()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'admin_dashboard' %}" id="editBookForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="edit_book">
          <input type="hidden" name="book_id" id="editBookId">
          
          <div class="form-row">
            <div class="form-group">
              <label>Title *</label>
              <input type="text" name="title" id="editBookTitle" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Main Author *</label>
              <input type="text" name="main_author" id="editBookMainAuthor" required>
            </div>
            <div class="form-group">
              <label>Co-Author</label>
              <input type="text" name="co_author" id="editBookCoAuthor">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Publisher</label>
              <input type="text" name="publisher" id="editBookPublisher">
            </div>
            <div class="form-group">
              <label>Edition</label>
              <input type="text" name="edition" id="editBookEdition">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Call Number *</label>
              <input type="text" name="call_number" id="editBookCallNumber" required>
            </div>
            <div class="form-group">
              <label>Language</label>
              <select name="language" id="editBookLanguage">
                <option value="English">English</option>
                <option value="Filipino">Filipino</option>
                <option value="Spanish">Spanish</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Type</label>
              <select name="type" id="editBookType">
                <option value="Analytics">Analytics</option>
                <option value="Article">Article</option>
                <option value="Books">Books</option>
                <option value="Thesis">Thesis</option>
                <option value="DOST Resources">DOST Resources</option>
                <option value="Journal">Journal</option>
                <option value="US Reference Materials">US Reference Materials</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group" style="width: 100%;">
              <label>Copies</label>
              <div id="editBookCopiesContainer" style="display: flex; flex-direction: column; gap: 10px; padding: 12px; background: var(--app-container); border: 2px solid var(--message-box-border); border-radius: 12px;"></div>
              <small style="display:block; color: var(--secondary-color); margin-top: 6px;">Edit each copy's Status/Location. Deleting a copy is destructive and will ask for confirmation.</small>
            </div>
          </div>
          
          <div class="modal-actions">
            <button type="button" onclick="closeBookEditModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 style="margin: 0; color: #333;">Edit User</h2>
          <button onclick="closeUserEditModal()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'admin_dashboard' %}" id="editUserForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="edit_user">
          <input type="hidden" name="old_school_id" id="editUserOldSchoolId">
          <input type="hidden" name="old_grade_num" id="editUserOldGradeNum">
          
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" name="name" id="editUserName" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>School ID *</label>
              <input type="text" name="school_id" id="editUserSchoolId" required>
            </div>
            <div class="form-group">
              <label>Grade</label>
              <select name="grade_num" id="editUserGradeNum" required>
                <option value="7">Grade 7</option>
                <option value="8">Grade 8</option>
                <option value="9">Grade 9</option>
                <option value="10">Grade 10</option>
                <option value="11">Grade 11</option>
                <option value="12">Grade 12</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" name="email" id="editUserEmail" required>
            </div>
            <div class="form-group">
              <label>Batch</label>
              <input type="text" name="batch" id="editUserBatch">
            </div>
          </div>
          
          <div class="modal-actions">
            <button type="button" onclick="closeUserEditModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Save Changes</button>
            <button type="button" onclick="confirmDeleteUser()" class="btn-secondary" style="margin-left: auto; background: #dc3545; color: white; border-color: #dc3545;">Delete User</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Move-Up Modal -->
    <div id="moveUpModal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 520px;">
        <div class="modal-header">
          <h2 style="margin: 0; color: #333;">Move-Up Students</h2>
          <button onclick="closeMoveUpModal()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'admin_dashboard' %}" id="moveUpForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="move_up">
          <div class="form-row">
            <div class="form-group" style="width:100%;">
              <label>Confirm with your password</label>
              <input type="password" name="password" id="moveUpPassword" required placeholder="Enter your password">
              <small style="display:block; color: var(--secondary-color); margin-top: 6px;">This will move Grade 7→8, 8→9, 9→10, 10→11, 11→12 and graduate Grade 12.</small>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" onclick="closeMoveUpModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary" style="background:#dc3545;">Run Move-Up</button>
          </div>
        </form>
      </div>
    </div>

    <script src="{% static 'Scripts/js/cadmin.js' %}"></script>
    <script>

      // Form validation and status handlers
      document.addEventListener('DOMContentLoaded', function() {
        // Check if we need to show a specific view after POST
        const activeView = '{{ active_view|default:"borrowed" }}';
        if (activeView !== 'borrowed') {
          // Hide all views first
          document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
          
          // Show the active view
          const viewToShow = document.getElementById(activeView + '-view');
          if (viewToShow) {
            viewToShow.style.display = 'block';
            
            // Update sidebar active state
            document.querySelectorAll('.app-sidebar-link').forEach(link => {
              link.classList.remove('active');
              if (link.getAttribute('data-view') === activeView) {
                link.classList.add('active');
              }
            });
          }
        }
        
        // Checkout form handler
        const checkoutForm = document.getElementById('checkout-form');
        const checkoutBarcodeInput = document.getElementById('checkout-barcode-input');
        const checkoutStudentInput = document.getElementById('checkout-student-input');
        const checkoutStatusDiv = document.getElementById('checkout-status');
        const checkoutSubmitBtn = document.getElementById('checkout-submit-btn');

        if (checkoutForm) {
          checkoutForm.addEventListener('submit', function(e) {
            const barcode = checkoutBarcodeInput.value.trim();
            const studentId = checkoutStudentInput.value.trim();
            
            if (!barcode || !studentId) {
              e.preventDefault();
              showCheckoutStatus('Please fill in all fields', 'error');
              return;
            }
            
            // Show loading state
            checkoutSubmitBtn.disabled = true;
            checkoutSubmitBtn.textContent = 'Processing...';
            showCheckoutStatus('Processing checkout...', 'info');
          });

          // Clear status on input
          checkoutBarcodeInput.addEventListener('input', clearCheckoutStatus);
          checkoutStudentInput.addEventListener('input', clearCheckoutStatus);
        }

        function showCheckoutStatus(message, type) {
          checkoutStatusDiv.innerHTML = '';
          checkoutStatusDiv.style.display = 'block';
          checkoutStatusDiv.style.padding = '0.75rem';
          checkoutStatusDiv.style.borderRadius = '6px';
          checkoutStatusDiv.style.marginBottom = '0.5rem';
          
          if (type === 'success') {
            checkoutStatusDiv.style.background = '#d4edda';
            checkoutStatusDiv.style.color = '#155724';
            checkoutStatusDiv.style.borderLeft = '4px solid #28a745';
            checkoutStatusDiv.innerHTML = '<strong>✓ Success:</strong> ' + message;
          } else if (type === 'error') {
            checkoutStatusDiv.style.background = '#f8d7da';
            checkoutStatusDiv.style.color = '#721c24';
            checkoutStatusDiv.style.borderLeft = '4px solid #dc3545';
            checkoutStatusDiv.innerHTML = '<strong>✗ Error:</strong> ' + message;
          } else {
            checkoutStatusDiv.style.background = '#d1ecf1';
            checkoutStatusDiv.style.color = '#0c5460';
            checkoutStatusDiv.style.borderLeft = '4px solid #17a2b8';
            checkoutStatusDiv.innerHTML = '<strong>ℹ Info:</strong> ' + message;
          }
        }

        function clearCheckoutStatus() {
          checkoutStatusDiv.style.display = 'none';
          if (checkoutSubmitBtn) {
            checkoutSubmitBtn.disabled = false;
            checkoutSubmitBtn.textContent = 'Checkout Book';
          }
        }

        // Return form (barcode) handler
        const barcodeForm = document.getElementById('barcode-return-form');
        const barcodeInput = document.getElementById('barcode-input');
        const barcodeStatusDiv = document.getElementById('barcode-status');
        const returnSubmitBtn = document.getElementById('return-submit-btn');
        const returnStatusDiv = document.getElementById('return-status');

        if (barcodeForm && barcodeInput) {
          barcodeForm.addEventListener('submit', function(e) {
            const accessionNumber = barcodeInput.value.trim();
            if (!accessionNumber) {
              e.preventDefault();
              showBarcodeStatus('Please enter or scan a barcode', 'error');
              return;
            }
            
            // Show loading state
            returnSubmitBtn.disabled = true;
            returnSubmitBtn.textContent = 'Processing...';
            showBarcodeStatus('Processing return...', 'info');
          });

          // Auto-clear status message on input
          barcodeInput.addEventListener('input', function() {
            clearBarcodeStatus();
          });
        }

        function showBarcodeStatus(message, type) {
          barcodeStatusDiv.innerHTML = '';
          barcodeStatusDiv.style.display = 'block';
          barcodeStatusDiv.style.padding = '0.75rem';
          barcodeStatusDiv.style.borderRadius = '6px';
          
          if (type === 'success') {
            barcodeStatusDiv.style.background = '#d4edda';
            barcodeStatusDiv.style.color = '#155724';
            barcodeStatusDiv.style.borderLeft = '4px solid #28a745';
            barcodeStatusDiv.innerHTML = '<strong>✓ Success:</strong> ' + message;
            // Clear input on success
            setTimeout(() => {
              if (barcodeInput) {
                barcodeInput.value = '';
                barcodeInput.focus();
              }
              clearBarcodeStatus();
            }, 2000);
          } else if (type === 'error') {
            barcodeStatusDiv.style.background = '#f8d7da';
            barcodeStatusDiv.style.color = '#721c24';
            barcodeStatusDiv.style.borderLeft = '4px solid #dc3545';
            barcodeStatusDiv.innerHTML = '<strong>✗ Error:</strong> ' + message;
          } else {
            barcodeStatusDiv.style.background = '#d1ecf1';
            barcodeStatusDiv.style.color = '#0c5460';
            barcodeStatusDiv.style.borderLeft = '4px solid #17a2b8';
            barcodeStatusDiv.innerHTML = '<strong>ℹ Info:</strong> ' + message;
          }
        }

        function clearBarcodeStatus() {
          barcodeStatusDiv.style.display = 'none';
          if (returnSubmitBtn) {
            returnSubmitBtn.disabled = false;
            returnSubmitBtn.textContent = 'Return Book';
          }
        }

        // Auto-clear form and refocus after successful checkout
        const messagesDiv = document.querySelector('.messages');
        
        if (messagesDiv) {
          const hasSuccess = messagesDiv.innerHTML.includes('Success');
          
          // If on checkout view with success, clear and refocus
          if (hasSuccess && activeView === 'checkout' && checkoutBarcodeInput) {
            setTimeout(() => {
              checkoutBarcodeInput.value = '';
              checkoutStudentInput.value = '';
              checkoutBarcodeInput.focus();
            }, 100);
          }
          
          // If on return view with success, clear and refocus
          if (hasSuccess && activeView === 'return' && barcodeInput) {
            setTimeout(() => {
              barcodeInput.value = '';
              barcodeInput.focus();
            }, 100);
          }
          
          // Auto-fade messages after 5 seconds
          setTimeout(() => {
            messagesDiv.style.transition = 'opacity 0.5s';
            messagesDiv.style.opacity = '0';
            setTimeout(() => {
              messagesDiv.style.display = 'none';
            }, 500);
          }, 5000);
        }
      });
      
      // Modal functions
      function openBookEditModal(id, title, mainAuthor, coAuthor, publisher, edition, callNumber, language, type, copiesJson) {
        document.getElementById('editBookId').value = id;
        document.getElementById('editBookTitle').value = title;
        document.getElementById('editBookMainAuthor').value = mainAuthor;
        document.getElementById('editBookCoAuthor').value = coAuthor;
        document.getElementById('editBookPublisher').value = publisher;
        document.getElementById('editBookEdition').value = edition;
        document.getElementById('editBookCallNumber').value = callNumber;
        document.getElementById('editBookLanguage').value = language;
        document.getElementById('editBookType').value = type;

        // render copies editor
        const container = document.getElementById('editBookCopiesContainer');
        container.innerHTML = '';
        let copies = [];
        try {
          copies = copiesJson ? JSON.parse(copiesJson) : [];
        } catch (e) {
          copies = [];
        }

        if (!copies || copies.length === 0) {
          const empty = document.createElement('div');
          empty.style.color = 'var(--secondary-color)';
          empty.style.fontSize = '0.85rem';
          empty.textContent = 'No copies found for this book.';
          container.appendChild(empty);
        } else {
          copies.forEach((copy) => {
            const row = document.createElement('div');
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '140px 1fr 140px 110px';
            row.style.gap = '10px';
            row.style.alignItems = 'center';
            row.style.padding = '10px';
            row.style.borderRadius = '10px';
            row.style.background = 'var(--search-area-bg)';
            row.style.border = '1px solid var(--message-box-border)';

            const acc = document.createElement('div');
            acc.style.fontFamily = 'monospace';
            acc.style.fontSize = '0.85rem';
            acc.style.color = 'var(--main-color)';
            acc.textContent = copy.accessionNumber || '';

            const loc = document.createElement('input');
            loc.type = 'text';
            loc.name = 'copy_location';
            loc.value = copy.Location || '';
            loc.placeholder = 'Location';
            loc.style.width = '100%';
            loc.style.padding = '8px 10px';
            loc.style.border = '2px solid var(--message-box-border)';
            loc.style.borderRadius = '8px';
            loc.style.background = 'var(--search-area-bg)';
            loc.style.color = 'var(--main-color)';

            const status = document.createElement('select');
            status.name = 'copy_status';
            status.style.width = '100%';
            status.style.padding = '8px 10px';
            status.style.border = '2px solid var(--message-box-border)';
            status.style.borderRadius = '8px';
            status.style.background = 'var(--search-area-bg)';
            status.style.color = 'var(--main-color)';
            ['Available', 'Unavailable', 'Borrowed', 'Lost'].forEach((opt) => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt;
              if ((copy.status || '') === opt) o.selected = true;
              status.appendChild(o);
            });

            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'copy_id';
            hiddenId.value = copy.id;

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'btn-secondary';
            del.style.background = '#dc3545';
            del.style.color = 'white';
            del.style.borderColor = '#dc3545';
            del.textContent = 'Delete';
            del.onclick = function() {
              confirmDeleteCopy(copy.id, copy.accessionNumber || '');
            };

            row.appendChild(acc);
            row.appendChild(loc);
            row.appendChild(status);
            row.appendChild(del);
            row.appendChild(hiddenId);
            container.appendChild(row);
          });
        }

        document.getElementById('editBookModal').style.display = 'flex';
      }
      
      function closeBookEditModal() {
        document.getElementById('editBookModal').style.display = 'none';
      }
      
      function openUserEditModal(schoolId, name, email, gradeNum, batch) {
        document.getElementById('editUserOldSchoolId').value = schoolId;
        document.getElementById('editUserOldGradeNum').value = String(gradeNum);
        document.getElementById('editUserSchoolId').value = schoolId;
        document.getElementById('editUserName').value = name;
        document.getElementById('editUserEmail').value = email;
        document.getElementById('editUserGradeNum').value = String(gradeNum);
        document.getElementById('editUserBatch').value = batch || '';
        document.getElementById('editUserModal').style.display = 'flex';
      }
      
      function closeUserEditModal() {
        document.getElementById('editUserModal').style.display = 'none';
      }

      function openMoveUpModal() {
        const input = document.getElementById('moveUpPassword');
        if (input) input.value = '';
        document.getElementById('moveUpModal').style.display = 'flex';
        setTimeout(() => {
          if (input) input.focus();
        }, 50);
      }

      function closeMoveUpModal() {
        document.getElementById('moveUpModal').style.display = 'none';
      }

      function postAction(fields) {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '{% url "admin_dashboard" %}';

        const csrf = document.querySelector('input[name=csrfmiddlewaretoken]');
        if (csrf) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrf.value;
          form.appendChild(csrfInput);
        }

        Object.keys(fields).forEach((k) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = k;
          input.value = fields[k];
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
      }

      function confirmDeleteCopy(copyId, accessionNumber) {
        if (!copyId) return;
        const ok = confirm('Delete copy ' + accessionNumber + '? This cannot be undone.');
        if (!ok) return;
        postAction({
          action: 'delete_copy',
          copy_id: String(copyId),
          confirm_delete: 'yes'
        });
      }

      function confirmDeleteUser() {
        const schoolId = document.getElementById('editUserOldSchoolId')?.value;
        const gradeNum = document.getElementById('editUserOldGradeNum')?.value;
        if (!schoolId || !gradeNum) return;
        const ok = confirm('Delete this user? This cannot be undone.');
        if (!ok) return;
        postAction({
          action: 'delete_user',
          school_id: schoolId,
          grade_num: gradeNum,
          confirm_delete: 'yes'
        });
      }

      function openBookAddModal() {
        // Clear previous values
        document.getElementById('addBookForm').reset();
        document.getElementById('addBookModal').style.display = 'flex';
      }

      function closeBookAddModal() {
        document.getElementById('addBookModal').style.display = 'none';
      }

      function openUserAddModal() {
        document.getElementById('addUserForm').reset();
        document.getElementById('addUserModal').style.display = 'flex';
      }

      function closeUserAddModal() {
        document.getElementById('addUserModal').style.display = 'none';
      }
      
      // Close modals when clicking outside
      window.onclick = function(event) {
        const bookModal = document.getElementById('editBookModal');
        const userModal = document.getElementById('editUserModal');
        const addBookModal = document.getElementById('addBookModal');
        const addUserModal = document.getElementById('addUserModal');
        const moveUpModal = document.getElementById('moveUpModal');
        if (event.target === bookModal) {
          closeBookEditModal();
        } else if (event.target === userModal) {
          closeUserEditModal();
        } else if (event.target === addBookModal) {
          closeBookAddModal();
        } else if (event.target === addUserModal) {
          closeUserAddModal();
        } else if (event.target === moveUpModal) {
          closeMoveUpModal();
        }
      }
      
      // Search functions
      function searchBooks() {
        const input = document.getElementById('bookSearch');
        const filter = input.value.toLowerCase();
        const booksList = document.getElementById('booksList');
        const items = booksList.getElementsByClassName('book-item');
        let visibleCount = 0;
        
        for (let i = 0; i < items.length; i++) {
          const title = items[i].getAttribute('data-title');
          const author = items[i].getAttribute('data-author');
          const accession = (items[i].getAttribute('data-accession') || '');
          
          if (title.includes(filter) || author.includes(filter) || accession.includes(filter)) {
            items[i].style.display = '';
            visibleCount++;
          } else {
            items[i].style.display = 'none';
          }
        }
        
        // Show "no results" message if no items visible
        let noResultsMsg = document.getElementById('booksNoResults');
        if (visibleCount === 0 && filter !== '') {
          if (!noResultsMsg) {
            noResultsMsg = document.createElement('p');
            noResultsMsg.id = 'booksNoResults';
            noResultsMsg.style.cssText = 'text-align: center; color: var(--secondary-color); padding: 20px; font-size: 0.8rem;';
            noResultsMsg.textContent = 'No books found';
            booksList.appendChild(noResultsMsg);
          }
        } else if (noResultsMsg) {
          noResultsMsg.remove();
        }
      }
      
      function searchUsers() {
        const input = document.getElementById('userSearch');
        const filter = input.value.toLowerCase();
        const usersList = document.getElementById('usersList');
        const gradeSections = usersList.getElementsByClassName('grade-section');
        let totalVisibleCount = 0;
        
        // Go through each grade section
        for (let section of gradeSections) {
          const items = section.getElementsByClassName('user-item');
          let visibleInSection = 0;
          
          // Check each student in this section
          for (let item of items) {
            const name = item.getAttribute('data-name');
            const schoolId = item.getAttribute('data-schoolid');
            const grade = item.getAttribute('data-grade');
            const batch = item.getAttribute('data-batch');
            
            if (name.includes(filter) || schoolId.includes(filter) || grade.includes(filter) || batch.includes(filter)) {
              item.style.display = '';
              visibleInSection++;
              totalVisibleCount++;
            } else {
              item.style.display = 'none';
            }
          }
          
          // Show/hide entire grade section based on visible students
          if (filter !== '' && visibleInSection === 0) {
            section.style.display = 'none';
          } else {
            section.style.display = '';
            // Auto-open sections with search results
            if (filter !== '' && visibleInSection > 0) {
              section.setAttribute('open', '');
            }
          }
        }
        
        // Show "no results" message if no items visible
        let noResultsMsg = document.getElementById('usersNoResults');
        if (totalVisibleCount === 0 && filter !== '') {
          if (!noResultsMsg) {
            noResultsMsg = document.createElement('p');
            noResultsMsg.id = 'usersNoResults';
            noResultsMsg.style.cssText = 'text-align: center; color: var(--secondary-color); padding: 20px; font-size: 0.8rem;';
            noResultsMsg.textContent = 'No students found';
            usersList.appendChild(noResultsMsg);
          }
        } else if (noResultsMsg) {
          noResultsMsg.remove();
        }
      }
    </script>
  </body>
</html>
