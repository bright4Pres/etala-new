<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eTala</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0, maximum-scale=1.0">
  <link rel="stylesheet" href="../static/Scripts/css/index.css">
  <link rel="stylesheet" href="../static/Scripts/css/notif.css">
  <link rel="icon" href="../static/img/pisay.png">
</head>
<body>
{% include 'partials/upbox.html' %}
<header style=" background-image: url('../static/img/zrcpic.png'); background-size: cover; background-position-y: -120px; background-repeat: no-repeat;">
  <div class="container">
  <div class="row">
    <div class="col-10 col-md-7">
      <div class="row">
        <div class="col-10" >
          <h1 style="font-size: 4.6em;">A scholar's <br> star map to <br> wisdom.</h1>
        </div>
        <div class="col-10">
          <p> Enter a title, author, or keyword to begin your journey </p>
          <div id="searchContainer" style="width: 60%;">
            <form id="globalSearchForm" method="GET" onsubmit="redirectToRecords(event);">
                {% csrf_token %}
                <input type="text" id="librarySearch" class="form-control"
                      placeholder="Search the Library"
                      value="{{ request.GET.search|default:'' }}"
                      style="width: 80%; padding-left: 1em; font-size: 1.4em">
            </form>
            </div>
        </div>
      </div>
    </div>
    <div class="col-10 col-md-3">
      <div style="background-image: url('../static/img/pisaylogo.svg'); background-size: cover; height:300px; width: 300px; background-repeat: no-repeat;"> </div>  
    </div>
  </div>
</div>
</header>
<main>
  <section class="optionsContainer" id="home" style="height: auto; min-height: 50vh; padding: 2em 0; justify-content: center; align-content: center; align-items: center;">
    {% include 'partials/options.html' %}
  </section>
  <section class="about-section" id="todo">
    <div class="about-container">
      <h1 class="about-heading">About eTALA</h1>
      <p class="about-text">
        Project <span class="highlight">eTALA</span> began as an initiative by PSHSâ€“ZRC scholars who envisioned a modern, digital solution to improve the library's traditional paper-based cataloging system. Under the supervision of the Campus Librarian and Computer Science advisers, the team developed the concept into a functional OPAC platform designed to enhance accessibility, organization, and efficiency.
      </p>
      <p class="about-text">
        The project was formalized under the name <span class="highlight">Enhanced Technology-Assisted Library Access</span> and approved through the SCALE Program, marking its transition from proposal to full implementation. Beyond technical modernization, eTALA supports SDG 4 (Quality Education) and SDG 9 (Industry, Innovation, and Infrastructure) by improving access to learning resources and strengthening the school's information systems for the benefit of the entire PSHS-ZRC community.
      </p>
    </div>
  </section>
</main>

<!-- account registerer modal pop up -->
<div id="registerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="form-container">
      <div id="step1" class="registration-step">
        <h3>Step 1: Select Your Grade</h3>
        <div class="form-group">
          <label for="gradeSelect">Grade</label>
          <select id="gradeSelect" required>
            <option value="">-- Select Grade --</option>
            <option value="7">Grade 7</option>
            <option value="8">Grade 8</option>
            <option value="9">Grade 9</option>
            <option value="10">Grade 10</option>
            <option value="11">Grade 11</option>
            <option value="12">Grade 12</option>
          </select>
        </div>
        <button class="form-submit-btn" id="nextToStudents" type="button">Next</button>
      </div>

      <div id="step2" class="registration-step" style="display: none;">
        <h3>Step 2: Select Your Name</h3>
        <div class="form-group">
          <label for="studentSelect">Student Name</label>
          <select id="studentSelect" required>
            <option value="">-- Loading students --</option>
          </select>
        </div>
        <button class="form-submit-btn" id="backToGrade" type="button" style="background-color: #999;">Back</button>
        <button class="form-submit-btn" id="nextToEmail" type="button">Next</button>
      </div>

      <div id="step3" class="registration-step" style="display: none;">
        <h3>Step 3: Verify Email</h3>
        <div class="form-group">
          <label for="studentEmail">Email Address</label>
          <input type="email" id="studentEmail" placeholder="Enter your email address" required="">
        </div>
        <p id="emailHelp" style="font-size: 0.9em; color: #666; margin-top: 10px;"></p>
        <button class="form-submit-btn" id="backToStudent" type="button" style="background-color: #999;">Back</button>
        <button class="form-submit-btn" id="sendOtp" type="button">Send OTP</button>
      </div>

      <div id="step4" class="registration-step" style="display: none;">
        <h3>Step 4: Enter OTP</h3>
        <p style="font-size: 0.95em; color: #333; margin-bottom: 20px;">We've sent a 6-digit OTP to your email.</p>
        <div class="form-group">
          <label for="otpInput">OTP Code</label>
          <input type="text" id="otpInput" maxlength="6" placeholder="e.g. 123456" required="">
        </div>
        <p id="otpHelp" style="font-size: 0.9em; color: #666; margin-top: 10px;">OTP expires in 10 minutes</p>
        <button class="form-submit-btn" id="backToEmail" type="button" style="background-color: #999;">Back</button>
        <button class="form-submit-btn" id="verifyOtp" type="button">Activate Account</button>
        <button class="form-link-btn" id="resendOtp" type="button" style="background-color: transparent; color: #007bff; border: none; text-decoration: underline; cursor: pointer; margin-top: 10px;">Didn't receive OTP? Resend</button>
      </div>
    </div>
  </div>
</div>
<div id="notification" class="notification"></div>

<!-- partial -->
<script>
  function redirectToRecords(event) {
    event.preventDefault();
    const searchValue = document.getElementById('librarySearch').value;
    window.location.href = `/records?search=${encodeURIComponent(searchValue)}`;
  }

  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("registerModal");
    const span = document.getElementsByClassName("close")[0];
    const mainContent = document.querySelector("main");
    const notification = document.getElementById("notification");

    // Close button handler
    if (span) {
      span.onclick = function() {
        modal.style.display = "none";
        mainContent.classList.remove("blurred");
        resetRegistrationForm();
      }
    }

    // Click outside modal to close
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
        mainContent.classList.remove("blurred");
        resetRegistrationForm();
      }
    }

    // Registration flow state
    let registrationState = {
      grade: null,
      studentId: null,
      studentName: null,
      email: null,
      activationId: null,
    };

    function showStep(stepNumber) {
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) step.style.display = i === stepNumber ? "block" : "none";
      }
    }

    function resetRegistrationForm() {
      registrationState = {
        grade: null,
        studentId: null,
        studentName: null,
        email: null,
        activationId: null,
      };
      document.getElementById("gradeSelect").value = "";
      document.getElementById("studentSelect").innerHTML = '<option value="">-- Select student --</option>';
      document.getElementById("studentEmail").value = "";
      document.getElementById("otpInput").value = "";
      showStep(1);
    }

    // Step 1: Grade selected
    document.getElementById("nextToStudents").onclick = async function() {
      const grade = document.getElementById("gradeSelect").value;
      if (!grade) {
        showNotification("Please select a grade");
        return;
      }

      registrationState.grade = grade;

      // Fetch students for this grade
      try {
        const response = await fetch("/api/get-students/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ grade: grade }),
        });

        const data = await response.json();
        if (data.success) {
          // Populate student dropdown
          const studentSelect = document.getElementById("studentSelect");
          studentSelect.innerHTML = '<option value="">-- Select student --</option>';
          
          data.students.forEach(student => {
            const option = document.createElement("option");
            option.value = student.id;
            option.textContent = `${student.name} (${student.school_id})`;
            option.dataset.email = student.email;
            studentSelect.appendChild(option);
          });

          showStep(2);
        } else {
          showNotification(data.error || "Error fetching students");
        }
      } catch (error) {
        showNotification("Error: " + error.message);
      }
    }

    // Step 2: Student selected
    document.getElementById("nextToEmail").onclick = function() {
      const studentSelect = document.getElementById("studentSelect");
      const selectedOption = studentSelect.options[studentSelect.selectedIndex];

      if (!selectedOption || selectedOption.value === "") {
        showNotification("Please select a student");
        return;
      }

      registrationState.studentId = selectedOption.value;
      registrationState.studentName = selectedOption.textContent;
      registrationState.email = selectedOption.dataset.email;

      // Show the email in step 3
      document.getElementById("emailHelp").textContent = 
        `Confirm this email matches your school record`;

      showStep(3);
    }

    // Step 3: Email verification and OTP sending
    document.getElementById("sendOtp").onclick = async function() {
      const enteredEmail = document.getElementById("studentEmail").value.trim();

      if (!enteredEmail) {
        showNotification("Please enter your email");
        return;
      }

      // Cross-reference email
      if (enteredEmail.toLowerCase() !== registrationState.email.toLowerCase()) {
        showNotification("Email does not match our records. Please try again.");
        return;
      }

      // Send OTP request
      try {
        const response = await fetch("/api/verify-email/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            grade: registrationState.grade,
            student_id: registrationState.studentId,
            email: enteredEmail,
          }),
        });

        const data = await response.json();
        if (data.success) {
          registrationState.activationId = data.activation_id;
          showNotification(data.message);
          showStep(4);
        } else {
          showNotification(data.error || "Error sending OTP");
        }
      } catch (error) {
        showNotification("Error: " + error.message);
      }
    }

    // Step 4: OTP verification
    document.getElementById("verifyOtp").onclick = async function() {
      const otp = document.getElementById("otpInput").value.trim();

      if (!otp || otp.length !== 6) {
        showNotification("OTP must be 6 digits");
        return;
      }

      try {
        const response = await fetch("/api/verify-otp/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            activation_id: registrationState.activationId,
            otp: otp,
          }),
        });

        const data = await response.json();
        if (data.success) {
          showNotification(data.message);
          setTimeout(() => {
            modal.style.display = "none";
            mainContent.classList.remove("blurred");
            resetRegistrationForm();
          }, 2000);
        } else {
          showNotification(data.error || "Error verifying OTP");
        }
      } catch (error) {
        showNotification("Error: " + error.message);
      }
    }

    // Resend OTP
    document.getElementById("resendOtp").onclick = async function() {
      try {
        const response = await fetch("/api/resend-otp/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            activation_id: registrationState.activationId,
          }),
        });

        const data = await response.json();
        if (data.success) {
          showNotification(data.message);
          document.getElementById("otpInput").value = "";
        } else {
          showNotification(data.error || "Error resending OTP");
        }
      } catch (error) {
        showNotification("Error: " + error.message);
      }
    }

    // Back buttons
    document.getElementById("backToGrade").onclick = () => showStep(1);
    document.getElementById("backToStudent").onclick = () => showStep(2);
    document.getElementById("backToEmail").onclick = () => showStep(3);

    // CSRF Token Helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showNotification(message) {
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  });
</script>
</body>
</html>