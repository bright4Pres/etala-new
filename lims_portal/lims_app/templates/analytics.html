<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - eTala Library</title>
    <script>
      // Set theme immediately to prevent flash
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.classList.add(theme);
      })();
    </script>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://public.codepenassets.com/css/normalize-5.0.0.min.css">
    <link rel="stylesheet" href="../static/Scripts/css/cadmin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/Scripts/css/statistics.css">
    <script src="../static/Scripts/js/chart.js"></script>
    <style>
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        .app-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 300px;
            margin-left: -8px;
        }
        .search-wrapper {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 600px;
        }
        .main-container {
            max-width: 100%;
            padding: 24px;
        }
        .kpi-grid, .charts-grid {
            margin: 0 0 2rem 0;
        }
        .header-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .header-btn:hover {
            background: var(--bg-accent);
        }
        .app-logo {
            width: 36px;
            height: 36px;
            object-fit: contain;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }
        .app-logo:hover {
            transform: scale(1.05);
        }
        .app-name {
            margin: 0;
            font-weight: 600;
            white-space: nowrap;
        }
        .search-suggestions {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--content-bg);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }
        .search-suggestions.show {
            display: block;
        }
        .search-suggestion-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        .search-suggestion-item:hover {
            background: var(--message-box-hover);
        }
        .suggestion-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--main-color);
            margin-bottom: 0.3rem;
        }
        .suggestion-details {
            font-size: 0.85rem;
            color: var(--secondary-color);
            line-height: 1.4;
        }
        .suggestion-match {
            background: rgba(37, 99, 235, 0.15);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-weight: 500;
            color: var(--link-color);
        }
        .no-results {
            padding: 2rem;
            text-align: center;
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-header-left">
                <img src="../static/img/etalalogo.svg" alt="eTala Logo" class="app-logo">
                <p class="app-name">eTala Library</p>
                <div class="search-wrapper">
                    <input class="search-input" type="text" id="analyticsSearchInput" placeholder="Search..." autocomplete="off">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-search" viewBox="0 0 24 24">
                        <defs></defs>
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <div class="search-suggestions" id="analyticsSearchSuggestions"></div>
                </div>
            </div>
            <div class="app-header-right">
                <!-- Period Selector -->
                <form method="get" id="period-form" style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem;">
                    <label for="period-select" style="font-size: 0.9rem; color: var(--text-secondary);">Period:</label>
                    <select name="period" id="period-select" onchange="document.getElementById('period-form').submit()" style="padding: 0.3rem 0.5rem; border-radius: 4px; background: var(--search-area-bg); color: var(--main-color); border: 1px solid var(--border-light); font-size: 0.9rem;">
                        <option value="day" {% if request.GET.period == 'day' %}selected{% endif %}>Today</option>
                        <option value="week" {% if request.GET.period == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if request.GET.period == 'month' or not request.GET.period %}selected{% endif %}>This Month</option>
                        <option value="quarter" {% if request.GET.period == 'quarter' %}selected{% endif %}>This Quarter</option>
                        <option value="year" {% if request.GET.period == 'year' %}selected{% endif %}>This Year</option>
                    </select>
                    <!-- Preserve heatmap settings if present -->
                    <input type="hidden" name="heatmap_range" value="{{ request.GET.heatmap_range|default:'' }}">
                    <input type="hidden" name="heatmap_offset" value="{{ request.GET.heatmap_offset|default:'0' }}">
                </form>
                
                <!-- Export Button -->
                <button class="header-btn" title="Export Data" onclick="exportData()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </button>
                
                <!-- Refresh Button -->
                <button class="header-btn" title="Refresh Data" onclick="window.location.reload()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.64A9 9 0 0 1 3.51 15"></path>
                    </svg>
                </button>
                
                <button class="mode-switch" title="Switch Theme">
                    <svg class="moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="24" height="24" viewBox="0 0 24 24">
                        <defs></defs>
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
                </button>
                <button class="notification-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" /></svg>
                </button>
            </div>
            <button class="messages-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
            </button>
        </div>
        <div class="app-content">
            <div class="app-sidebar">
                <a href="{% url 'home' %}" class="app-sidebar-link" title="Home">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" /></svg>
                </a>
                <a href="{% url 'records' %}" class="app-sidebar-link" title="Records">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                </a>
                <a href="{% url 'about' %}" class="app-sidebar-link" title="About">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </a>
                <a href="{% url 'analytics' %}" class="app-sidebar-link active" title="Statistics">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                </a>
                <a href="#" class="app-sidebar-link" onclick="alert('Activation portal coming soon!'); return false;" title="Activate Account">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-check">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <polyline points="17 11 19 13 23 9"></polyline>
                    </svg>
                </a>
            </div>
        
            <main class="projects-section main-container">

        <!-- ==========================================
             MAIN KPI CARDS
             Key performance indicators at a glance
             ========================================== -->
        <div class="kpi-grid">
            <!-- Total Books in Library -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-info">
                        <h3>Total Books</h3>
                        <div class="kpi-value">{{ total_books_count|default:0 }}</div>
                        <div class="kpi-subtitle">in collection</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
            </div>
            
            <!-- Currently Borrowed Books -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-info">
                        <h3>Currently Borrowed</h3>
                        <div class="kpi-value">{{ currently_borrowed|default:0 }}</div>
                        <div class="kpi-subtitle">{{ available_books|default:0 }} available</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-book-reader"></i>
                    </div>
                </div>
            </div>

            <!-- Registered Users with trend indicator -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-info">
                        <h3>Registered Users</h3>
                        <div class="kpi-value">{{ total_accounts|default:0 }}</div>
                        <!-- Shows new accounts in selected period -->
                        <div class="kpi-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span>+{{ period_new_accounts|default:0 }} in {{ period_label|lower }}</span>
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>

            <!-- Total Borrows (all-time and period-specific) -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-info">
                        <h3>Total Borrows</h3>
                        <div class="kpi-value">{{ total_borrows_all_time|default:0 }}</div>
                        <div class="kpi-subtitle">{{ period_borrows|default:0 }} in {{ period_label|lower }}</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                </div>
            </div>
            
            <!-- Overdue Books - changes color based on count -->
            <div class="kpi-card kpi-card-{% if overdue_books > 0 %}danger{% else %}success{% endif %}">
                <div class="kpi-header">
                    <div class="kpi-info">
                        <h3>Overdue Books</h3>
                        <!-- Red if overdue books exist, green if none -->
                        <div class="kpi-value kpi-value-{% if overdue_books > 0 %}danger{% else %}success{% endif %}">
                            {{ overdue_books|default:0 }}
                        </div>
                        <div class="kpi-subtitle">need attention</div>
                    </div>
                    <div class="kpi-icon kpi-icon-{% if overdue_books > 0 %}danger{% else %}success{% endif %}">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
            
            <!-- Return Rate Percentage -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-info">
                        <h3>Return Rate</h3>
                        <div class="kpi-value">{{ return_rate|default:0 }}%</div>
                        <div class="kpi-subtitle">on-time returns</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             MAIN CHARTS SECTION
             Two primary charts for visualizing trends
             ========================================== -->
        <div class="charts-grid">
            <!-- Monthly Borrows Line Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Monthly Borrows Trend</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color legend-color-blue"></div>
                            <span>Borrows</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <!-- Chart.js canvas for monthly trend -->
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
    
            <!-- Daily Activity Bar Chart (Last 7 Days) -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Daily Activity (Last 7 Days)</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color legend-color-purple"></div>
                            <span>Borrows / Day</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <!-- Chart.js canvas for daily activity -->
                    <canvas id="userChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ==========================================
             ADDITIONAL CHARTS AND STATS
             Pie charts and performance metrics
             ========================================== -->
        <div class="additional-charts">
            <!-- Books by Type Pie Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Books by Type</h3>
                </div>
                <div class="pie-chart-container">
                    <!-- Chart.js pie chart for book types -->
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <!-- Books by Language Pie Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Books by Language</h3>
                </div>
                <div class="pie-chart-container">
                    <!-- Chart.js pie chart for languages -->
                    <canvas id="languageChart"></canvas>
                </div>
            </div>
            
            <!-- Library Performance Metrics Card -->
            <div class="metrics-card">
                <h3>Library Performance</h3>
                
                <!-- Book Utilization Progress Bar -->
                <div class="metric-item">
                    <div class="metric-header">
                        <span>Book Utilization</span>
                        <span>{{ currently_borrowed|default:0 }}/{{ total_books_count|default:1 }}</span>
                    </div>
                    <div class="progress-bar">
                        <!-- Progress bar animated via JavaScript using data-percent attribute -->
                        <div class="progress-fill progress-fill-blue" data-percent="{{ utilization_percent|default:0 }}" style="width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Return Rate Progress Bar -->
                <div class="metric-item">
                    <div class="metric-header">
                        <span>Return Rate</span>
                        <span>{{ return_rate|default:0 }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-fill-green" data-percent="{{ return_rate|default:0 }}" style="width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Average Borrow Duration Progress Bar -->
                <div class="metric-item">
                    <div class="metric-header">
                        <span>Avg. Borrow Duration</span>
                        <span>{{ avg_borrow_days|default:0 }} days</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-fill-purple" data-percent="{{ avg_borrow_percent|default:0 }}" style="width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Active Period Borrows Progress Bar -->
                <div class="metric-item">
                    <div class="metric-header">
                        <span>Active Period Borrows</span>
                        <span>{{ period_borrows|default:0 }}</span>
                    </div>
                    <div class="progress-bar">
                        <!-- Hardcoded width as this is a relative indicator -->
                        <div class="progress-fill progress-fill-orange" style="width: 85%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TOP STATS GRID
             Three cards showing ranked statistics
             ========================================== -->
        <div class="stats-grid">
            <!-- Top Borrowers Leaderboard -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-star"></i> Top Borrowers</h3>
                </div>
                <div class="activity-list">
                    <!-- Loop through top borrowers from Django context -->
                    {% for borrower in top_borrowers %}
                    <div class="activity-item activity-item-border">
                        <div class="activity-content">
                            <div class="activity-icon icon-blue">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="activity-text">
                                <h4>{{ borrower.accountName }}</h4>
                                <p>ID: {{ borrower.accountID }}</p>
                            </div>
                        </div>
                        <div class="activity-time activity-count-blue">
                            {{ borrower.borrow_count }} borrows
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-state">No data available</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Most Borrowed Books List -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-fire"></i> Most Borrowed Books</h3>
                </div>
                <div class="activity-list">
                    <!-- Loop through most borrowed books -->
                    {% for book in most_borrowed %}
                    <div class="activity-item activity-item-border">
                        <div class="activity-content">
                            <div class="activity-icon icon-purple">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="activity-text">
                                <!-- Truncate long titles to 5 words -->
                                <h4>{{ book.bookTitle|truncatewords:5 }}</h4>
                                <p>Acc: {{ book.bookID }}</p>
                            </div>
                        </div>
                        <div class="activity-time activity-count-purple">
                            {{ book.borrow_count }}x
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-state">No data available</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Location Statistics (Physical library locations) -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-map-marker-alt"></i> Location Stats</h3>
                </div>
                <div class="activity-list">
                    <!-- Loop through location statistics -->
                    {% for loc in location_stats %}
                    <div class="activity-item activity-item-border">
                        <div class="activity-content">
                            <div class="activity-icon icon-green">
                                <i class="fas fa-bookmark"></i>
                            </div>
                            <div class="activity-text">
                                <h4>{{ loc.Location|truncatewords:3 }}</h4>
                                <!-- Show available vs borrowed breakdown -->
                                <p>Available: {{ loc.available }} | Borrowed: {{ loc.borrowed }}</p>
                            </div>
                        </div>
                        <div class="activity-time activity-count-green">
                            {{ loc.total }} books
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-state">No data available</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Overall Gender Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-users"></i> Overall Gender Distribution</h3>
                </div>
                <div style="display: flex; justify-content: center; align-items: center; padding: 1rem; min-height: 400px;">
                    <canvas id="overallGenderChart" width="300" height="300" style="max-width: 100%;"></canvas>
                </div>
            </div>

            <!-- Gender Distribution by Grade -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-graduation-cap"></i> Gender Distribution by Grade</h3>
                    <select id="batchSelect" style="padding: 0.5rem; border-radius: 6px; background: var(--search-area-bg); color: var(--main-color); border: 2px solid var(--message-box-border); margin-left: auto;">
                        {% for batch in batch_gender_pie_data %}
                        <option value="{{ batch }}">{{ batch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; justify-content: center; align-items: center; padding: 1rem; min-height: 400px;">
                    <canvas id="batchGenderChart" width="300" height="300" style="max-width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <!-- ==========================================
             CALENDAR HEATMAP
             GitHub-style activity heatmap for borrows
             ========================================== -->
        <div class="chart-card heatmap-card" style="margin-bottom: 2em;">
            <div class="chart-header">
                <h3><i class="fas fa-calendar-alt"></i> Borrow Activity Calendar</h3>
                
                <!-- Heatmap navigation controls -->
                <div class="heatmap-controls" style="display: flex; align-items: center; gap: 1em; margin-top: 0.5em;">
                    <!-- Form to change date range and navigate through time periods -->
                    <form id="heatmap-range-form" method="get" style="display: flex; align-items: center; gap: 0.5em;">
                        <!-- Preserve current period filter when navigating heatmap -->
                        <input type="hidden" name="period" value="{{ request.GET.period|default_if_none:'' }}">
                        <!-- Navigate to previous period -->
                        <button type="submit" name="heatmap_offset" value="{{ heatmap_prev_offset }}" class="heatmap-nav-btn" title="Previous" style="font-size:1.2em;">&#8592;</button>
                        <!-- Select time range (week/month/year) -->
                        <select name="heatmap_range" id="heatmap-range-select" style="padding: 2px 6px;">
                            <option value="week" {% if heatmap_range == 'week' %}selected{% endif %}>Week</option>
                            <option value="month" {% if heatmap_range == 'month' %}selected{% endif %}>Month</option>
                            <option value="year" {% if heatmap_range == 'year' %}selected{% endif %}>Year</option>
                        </select>
                        <!-- Display current period label (e.g., "November 2025") -->
                        <span style="font-weight: 500;">{{ heatmap_period_label }}</span>
                        <!-- Navigate to next period (disabled if viewing current/future) -->
                        <button type="submit" name="heatmap_offset" value="{{ heatmap_next_offset }}" class="heatmap-nav-btn" title="Next" style="font-size:1.2em;" {% if not heatmap_can_go_next %}disabled{% endif %}>&#8594;</button>
                    </form>
                </div>
                <!-- Heatmap color intensity legend -->
                <div class="heatmap-legend">
                    <span class="heatmap-legend-label">Less</span>
                    <div class="heatmap-legend-scale">
                        <!-- Six intensity levels from 0 (none) to 5 (most) -->
                        <div class="heatmap-legend-box heatmap-level-0"></div>
                        <div class="heatmap-legend-box heatmap-level-1"></div>
                        <div class="heatmap-legend-box heatmap-level-2"></div>
                        <div class="heatmap-legend-box heatmap-level-3"></div>
                        <div class="heatmap-legend-box heatmap-level-4"></div>
                        <div class="heatmap-legend-box heatmap-level-5"></div>
                    </div>
                    <span class="heatmap-legend-label">More</span>
                </div>
            </div>
            <!-- Heatmap rendered by JavaScript -->
            <div id="calendar-heatmap" class="calendar-heatmap-container"></div>
        </div>

        <!-- ==========================================
             OVERDUE BOOKS ALERT
             Only shown if there are overdue books
             ========================================== -->
        {% if overdue_books > 0 %}
        <div class="chart-card chart-card-danger">
            <div class="chart-header">
                <h3 class="chart-header-danger">
                    <i class="fas fa-exclamation-circle"></i> Overdue Books ({{ overdue_books }})
                </h3>
            </div>
            <div class="activity-list">
                <!-- Loop through overdue books list -->
                {% for overdue in overdue_list %}
                <div class="activity-item">
                    <div class="activity-content">
                        <div class="activity-icon icon-red">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="activity-text">
                            <!-- Show book title and borrower info -->
                            <h4>{{ overdue.bookTitle|truncatewords:6 }}</h4>
                            <p>{{ overdue.accountName }} ({{ overdue.accountID }})</p>
                        </div>
                    </div>
                    <!-- Display due date in danger styling -->
                    <div class="activity-time activity-time-danger">
                        Due: {{ overdue.return_date|date:"M d, Y" }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- ==========================================
             RECENT ACTIVITY FEED
             Shows most recent borrow transactions
             ========================================== -->
        <div class="activity-card">
            <div class="activity-header">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
            </div>
            <div class="activity-list">
                <!-- Loop through recently borrowed books -->
                {% for activity in borrowed_books %}
                <div class="activity-item">
                    <div class="activity-content">
                        <div class="activity-icon icon-blue">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="activity-text">
                            <!-- Show book title and borrower -->
                            <h4>{{ activity.bookTitle|truncatewords:8 }} was borrowed</h4>
                            <p>{{ activity.accountName }} ({{ activity.accountID }})</p>
                        </div>
                    </div>
                    <!-- Display borrow date and time -->
                    <div class="activity-time">{{ activity.borrow_date|date:"M d, Y H:i" }}</div>
                </div>
                {% empty %}
                <p class="empty-state">No recent activity</p>
                {% endfor %}
            </div>
        </div>
    </main>
    </div>

    <!-- ==========================================
         DATA INJECTION FOR JAVASCRIPT
         Pass Django context data to JS for Chart.js
         ========================================== -->
    <script>
        // Inject metrics JSON from Django backend
        // escapejs filter prevents XSS attacks
        window.analyticsData = JSON.parse('{{ metrics_json|escapejs }}');
        window.overallGenderLabels = {{ overall_gender_labels|safe }};
        window.overallGenderData = {{ overall_gender_data|safe }};
        window.batchGenderPieData = {{ batch_gender_pie_data|safe }};
    </script>
    
    <!-- Main statistics JavaScript file (handles Chart.js rendering and interactions) -->
    <script src="../static/Scripts/js/statistics.js"></script>
    <script>
        // Gender Pie Charts
        document.addEventListener('DOMContentLoaded', function() {
            // Overall Gender Chart
            const overallCtx = document.getElementById('overallGenderChart').getContext('2d');
            new Chart(overallCtx, {
                type: 'pie',
                data: {
                    labels: window.overallGenderLabels,
                    datasets: [{
                        data: window.overallGenderData,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 205, 86, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 205, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Batch Gender Chart
            const batchCtx = document.getElementById('batchGenderChart').getContext('2d');
            let batchChart = new Chart(batchCtx, {
                type: 'pie',
                data: {
                    labels: window.batchGenderPieData['Grade 7'].labels,
                    datasets: [{
                        data: window.batchGenderPieData['Grade 7'].data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 205, 86, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 205, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Batch selector
            document.getElementById('batchSelect').addEventListener('change', function() {
                const selectedBatch = this.value;
                const data = window.batchGenderPieData[selectedBatch];
                batchChart.data.labels = data.labels;
                batchChart.data.datasets[0].data = data.data;
                batchChart.update();
            });
        });
        
        // Export Data Function
        function exportData() {
            // Simple export - could be enhanced to export actual data
            alert('Export functionality coming soon! This would download analytics data as CSV/JSON.');
        }
    </script>
    <script>
      // Theme switcher (theme already loaded in head)
      document.querySelector(".mode-switch").addEventListener("click", function() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          document.documentElement.classList.add('light');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.remove('light');
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      });
    </script>
    <script>
      // Search functionality with YouTube-style suggestions
      const analyticsSearchInput = document.getElementById('analyticsSearchInput');
      const analyticsSuggestionsContainer = document.getElementById('analyticsSearchSuggestions');
      let analyticsSearchTimeout;

      if (analyticsSearchInput && analyticsSuggestionsContainer) {
        analyticsSearchInput.addEventListener('input', function() {
          const query = this.value.trim();
          clearTimeout(analyticsSearchTimeout);
          
          if (query.length < 2) {
            analyticsSuggestionsContainer.classList.remove('show');
            return;
          }
          
          analyticsSearchTimeout = setTimeout(() => {
            fetchSearchSuggestions(query, analyticsSuggestionsContainer);
          }, 300);
        });

        analyticsSearchInput.addEventListener('keypress', function(event) {
          if (event.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
              window.location.href = `/records/?search=${encodeURIComponent(query)}`;
            }
          }
        });

        document.addEventListener('click', function(event) {
          if (!event.target.closest('.search-wrapper')) {
            analyticsSuggestionsContainer.classList.remove('show');
          }
        });
      }

      function fetchSearchSuggestions(query, container) {
        fetch(`/records/?search=${encodeURIComponent(query)}`, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          displaySuggestions(data.books, query, container);
        })
        .catch(error => {
          console.error('Search error:', error);
        });
      }

      function displaySuggestions(books, query, container) {
        if (!books || books.length === 0) {
          container.innerHTML = '<div class="no-results">No books found</div>';
          container.classList.add('show');
          return;
        }

        const queryLower = query.toLowerCase();
        const html = books.slice(0, 8).map(book => {
          const matches = [];
          
          if (book.Title && book.Title.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Title</span>: ${highlightMatch(book.Title, query)}`);
          }
          if (book.mainAuthor && book.mainAuthor.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Author</span>: ${highlightMatch(book.mainAuthor, query)}`);
          }
          if (book.callNumber && book.callNumber.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Call Number</span>: ${highlightMatch(book.callNumber, query)}`);
          }
          
          const matchDetails = matches.length > 0 ? matches.join(' â€¢ ') : 'Match found';
          
          return `
            <div class="search-suggestion-item" onclick="goToRecords('${encodeURIComponent(query)}')">
              <div class="suggestion-title">${escapeHtml(book.Title)}</div>
              <div class="suggestion-details">
                ${matchDetails}<br>
                Available: <strong>${book.available_copies}/${book.total_copies}</strong> copies
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
        container.classList.add('show');
      }

      function highlightMatch(text, query) {
        if (!text) return '';
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return escapeHtml(text).replace(regex, '<span class="suggestion-match">$1</span>');
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function goToRecords(query) {
        window.location.href = `/records/?search=${query}`;
      }
    </script>
    </div>
  </div>
</body>
</html>