<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>eTala - Library Portal</title>
    <script>
      // Set theme immediately to prevent flash
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.classList.add(theme);
      })();
    </script>
    <link rel="stylesheet" href="https://public.codepenassets.com/css/normalize-5.0.0.min.css">
    <link rel="stylesheet" href="../static/Scripts/css/cadmin.css">
    <style>
      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .app-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 300px;
      }
      .app-header-right {
        width: 80px;
        display: flex;
        justify-content: flex-end;
      }
      .search-wrapper {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 600px;
        max-width: 600px;
      }
      .search-suggestions {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: var(--content-bg);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
      }
      .search-suggestions.show {
        display: block;
      }
      .search-suggestion-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .search-suggestion-item:last-child {
        border-bottom: none;
      }
      .search-suggestion-item:hover {
        background: var(--message-box-hover);
      }
      .suggestion-title {
        font-weight: 600;
        font-size: 1rem;
        color: var(--main-color);
        margin-bottom: 0.3rem;
      }
      .suggestion-details {
        font-size: 0.85rem;
        color: var(--secondary-color);
        line-height: 1.4;
      }
      .suggestion-match {
        background: rgba(37, 99, 235, 0.15);
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        font-weight: 500;
        color: var(--link-color);
      }
      .no-results {
        padding: 2rem;
        text-align: center;
        color: var(--secondary-color);
      }
    </style>
  </head>
    
  <body>
  <div class="app-container">
  <div class="app-header">
    <div class="app-header-left">
      <img src="../static/img/etalalogo.svg" alt="eTala Logo" class="app-logo" style="width: 40px; height: 40px;">
      <p class="app-name">eTala Library</p>
      <div class="search-wrapper">
        <input class="search-input" type="text" id="mainSearchInput" placeholder="Search books..." autocomplete="off">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-search" viewBox="0 0 24 24">
          <defs></defs>
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <div class="search-suggestions" id="searchSuggestions"></div>
      </div>
    </div>
    <div class="app-header-right">
      <button class="mode-switch" title="Switch Theme">
        <svg class="moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="24" height="24" viewBox="0 0 24 24">
          <defs></defs>
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="app-content">
    <div class="app-sidebar">
      <a href="{% url 'home' %}" class="app-sidebar-link active" title="Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <polyline points="9 22 9 12 15 12 15 22" /></svg>
      </a>
      <a href="{% url 'records' %}" class="app-sidebar-link" title="Records">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
      </a>
      <a href="{% url 'about' %}" class="app-sidebar-link" title="About">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      </a>
      <a href="{% url 'analytics' %}" class="app-sidebar-link" title="Statistics">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
      </a>
      <a href="#" class="app-sidebar-link" onclick="alert('Activation portal coming soon!'); return false;" title="Activate Account">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-check">
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="8.5" cy="7" r="4"></circle>
          <polyline points="17 11 19 13 23 9"></polyline>
        </svg>
      </a>
    </div>
    
    <div class="projects-section">
      <div class="projects-section-header">
        <p>Welcome to eTala Library</p>
        <p class="time">Search for books using the search bar above</p>
      </div>
      <div class="projects-section-line">
        <div class="projects-status">
          <div class="item-status">
            <span class="status-number">Use the search bar above to find books by:</span>
            <span class="status-type">• Title • Author • Call Number • Publisher</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <script src="../static/Scripts/js/cadmin.js"></script>
    <script>
      // Search functionality with YouTube-style suggestions
      const searchInput = document.getElementById('mainSearchInput');
      const suggestionsContainer = document.getElementById('searchSuggestions');
      let searchTimeout;

      // Debounce search to avoid too many requests
      searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          suggestionsContainer.classList.remove('show');
          return;
        }
        
        searchTimeout = setTimeout(() => {
          fetchSearchSuggestions(query);
        }, 300);
      });

      function fetchSearchSuggestions(query) {
        fetch(`/records/?search=${encodeURIComponent(query)}`, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          displaySuggestions(data.books, query);
        })
        .catch(error => {
          console.error('Search error:', error);
        });
      }

      function displaySuggestions(books, query) {
        if (!books || books.length === 0) {
          suggestionsContainer.innerHTML = '<div class="no-results">No books found</div>';
          suggestionsContainer.classList.add('show');
          return;
        }

        const queryLower = query.toLowerCase();
        const html = books.slice(0, 8).map(book => {
          // Determine what matched the search
          const matches = [];
          
          if (book.Title && book.Title.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Title</span>: ${highlightMatch(book.Title, query)}`);
          }
          if (book.mainAuthor && book.mainAuthor.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Author</span>: ${highlightMatch(book.mainAuthor, query)}`);
          }
          if (book.coAuthor && book.coAuthor.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Co-Author</span>: ${highlightMatch(book.coAuthor, query)}`);
          }
          if (book.callNumber && book.callNumber.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Call Number</span>: ${highlightMatch(book.callNumber, query)}`);
          }
          if (book.Publisher && book.Publisher.toLowerCase().includes(queryLower)) {
            matches.push(`<span class="suggestion-match">Publisher</span>: ${highlightMatch(book.Publisher, query)}`);
          }
          
          const matchDetails = matches.length > 0 ? matches.join(' • ') : 'Match found';
          
          return `
            <div class="search-suggestion-item" onclick="goToRecords('${encodeURIComponent(query)}')">
              <div class="suggestion-title">${escapeHtml(book.Title)}</div>
              <div class="suggestion-details">
                ${matchDetails}<br>
                Available: <strong>${book.available_copies}/${book.total_copies}</strong> copies
              </div>
            </div>
          `;
        }).join('');

        suggestionsContainer.innerHTML = html;
        suggestionsContainer.classList.add('show');
      }

      function highlightMatch(text, query) {
        if (!text) return '';
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return escapeHtml(text).replace(regex, '<span class="suggestion-match">$1</span>');
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function goToRecords(query) {
        window.location.href = `/records/?search=${query}`;
      }

      // Close suggestions when clicking outside
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.centered-search-box')) {
          suggestionsContainer.classList.remove('show');
        }
      });

      // Handle Enter key to go to fsearch-wrapper
      searchInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
          const query = this.value.trim();
          if (query) {
            goToRecords(encodeURIComponent(query));
          }
        }
      });
    </script>
  </body>
</html>
